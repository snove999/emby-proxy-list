name: Fetch Proxy List

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©6ç‚¹
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # ========== ç¼“å­˜ npm ä¾èµ– ==========
      - name: Cache npm dependencies
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-playwright-v1
          restore-keys: |
            ${{ runner.os }}-npm-
      
      # ========== ç¼“å­˜ Playwright æµè§ˆå™¨ ==========
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-v1
          restore-keys: |
            ${{ runner.os }}-playwright-
      
      # ========== å®‰è£…ä¾èµ–ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰ ==========
      - name: Install Playwright
        run: |
          echo "ğŸ“¦ npm ç¼“å­˜çŠ¶æ€: ${{ steps.npm-cache.outputs.cache-hit }}"
          echo "ğŸŒ Playwright ç¼“å­˜çŠ¶æ€: ${{ steps.playwright-cache.outputs.cache-hit }}"
          
          # å®‰è£… playwright åŒ…
          npm install playwright
          
          # ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ä¸‹è½½æµè§ˆå™¨
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            echo "â¬‡ï¸ é¦–æ¬¡è¿è¡Œï¼Œä¸‹è½½ Chromium..."
            npx playwright install chromium
          else
            echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ Chromium"
          fi
      
      - name: Fetch with Playwright
        run: |
          cat << 'SCRIPT' > fetch.js
          const { chromium } = require('playwright');
          const fs = require('fs');

          const MAX_RETRIES = 3;

          async function fetchProxies(attempt = 1) {
            console.log(`\n========== ç¬¬ ${attempt} æ¬¡å°è¯• ==========`);
            
            const browser = await chromium.launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            try {
              const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                viewport: { width: 1920, height: 1080 },
                locale: 'en-US'
              });
              
              const page = await context.newPage();
              
              console.log('è®¿é—®é¡µé¢...');
              await page.goto('https://ipdb.api.030101.xyz/?type=bestproxy;bestcf;proxy&country=true', {
                waitUntil: 'domcontentloaded',
                timeout: 30000
              });
              
              // æ£€æŸ¥é¡µé¢æ ‡é¢˜ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨ Cloudflare éªŒè¯
              let title = await page.title();
              console.log('åˆå§‹é¡µé¢æ ‡é¢˜:', title);
              
              // å¦‚æœåœ¨éªŒè¯é¡µé¢ï¼Œç­‰å¾…éªŒè¯å®Œæˆ
              if (title.includes('moment') || title.includes('Cloudflare') || title.includes('Just')) {
                console.log('æ£€æµ‹åˆ° Cloudflare éªŒè¯ï¼Œç­‰å¾…ä¸­...');
                
                // ç­‰å¾…æ ‡é¢˜å˜åŒ–æˆ–è¶…æ—¶
                try {
                  await page.waitForFunction(
                    () => !document.title.includes('moment') && !document.title.includes('Just'),
                    { timeout: 30000 }
                  );
                } catch (e) {
                  console.log('ç­‰å¾…æ ‡é¢˜å˜åŒ–è¶…æ—¶ï¼Œç»§ç»­å°è¯•...');
                }
              }
              
              // Playwright çš„æ™ºèƒ½ç­‰å¾…
              console.log('ç­‰å¾…é¡µé¢ç¨³å®š...');
              try {
                await page.waitForLoadState('networkidle', { timeout: 30000 });
              } catch (e) {
                console.log('ç½‘ç»œæœªå®Œå…¨ç©ºé—²ï¼Œç»§ç»­å¤„ç†...');
              }
              
              // é¢å¤–ç­‰å¾…ç¡®ä¿å†…å®¹åŠ è½½
              await page.waitForTimeout(5000);
              
              // å†æ¬¡æ£€æŸ¥æ ‡é¢˜
              title = await page.title();
              console.log('æœ€ç»ˆé¡µé¢æ ‡é¢˜:', title);
              
              // è·å–é¡µé¢å†…å®¹
              const content = await page.textContent('body');
              console.log('å†…å®¹é•¿åº¦:', content.length);
              console.log('å†…å®¹é¢„è§ˆ:', content.substring(0, 300));
              
              // è§£æä»£ç†åˆ—è¡¨
              const lines = content.trim().split('\n').filter(line => {
                const trimmed = line.trim();
                return /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(trimmed);
              });
              
              console.log('è§£æåˆ°ä»£ç†æ•°é‡:', lines.length);
              
              if (lines.length >= 5) {
                fs.writeFileSync('proxies.txt', lines.join('\n'));
                console.log('\nâœ… æˆåŠŸï¼è·å–åˆ°', lines.length, 'ä¸ªä»£ç†');
                console.log('å‰10ä¸ª:', lines.slice(0, 10));
                return true;
              }
              
              // æ•°é‡ä¸è¶³ï¼Œå°è¯•é‡è¯•
              if (attempt < MAX_RETRIES) {
                console.log('ä»£ç†æ•°é‡ä¸è¶³ï¼Œå‡†å¤‡é‡è¯•...');
                await browser.close();
                await new Promise(r => setTimeout(r, 5000)); // ç­‰å¾…5ç§’åé‡è¯•
                return fetchProxies(attempt + 1);
              }
              
              // æœ€åä¸€æ¬¡ï¼Œå³ä½¿å°‘ä¹Ÿä¿å­˜
              if (lines.length > 0) {
                fs.writeFileSync('proxies.txt', lines.join('\n'));
                console.log('\nâš ï¸ ä»…è·å–åˆ°', lines.length, 'ä¸ªä»£ç†ï¼Œå·²ä¿å­˜');
                return true;
              }
              
              console.log('\nâŒ æœªèƒ½è·å–åˆ°æœ‰æ•ˆä»£ç†');
              return false;
              
            } finally {
              await browser.close();
            }
          }

          fetchProxies().then(success => {
            if (!success) {
              console.log('\næ‰€æœ‰å°è¯•å‡å¤±è´¥');
              process.exit(1);
            }
          }).catch(error => {
            console.error('æ‰§è¡Œé”™è¯¯:', error);
            process.exit(1);
          });
          SCRIPT
          
          node fetch.js
      
      - name: Verify result
        run: |
          echo "========== éªŒè¯ç»“æœ =========="
          if [ -f proxies.txt ]; then
            LINES=$(wc -l < proxies.txt)
            SIZE=$(wc -c < proxies.txt)
            echo "âœ… æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š ä»£ç†æ•°é‡: ${LINES} ä¸ª"
            echo "ğŸ“ æ–‡ä»¶å¤§å°: ${SIZE} å­—èŠ‚"
            echo ""
            echo "=== æ–‡ä»¶å†…å®¹é¢„è§ˆ (å‰20è¡Œ) ==="
            head -20 proxies.txt
          else
            echo "âŒ proxies.txt ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add proxies.txt
          
          if git diff --staged --quiet; then
            echo "âœ… æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            PROXY_COUNT=$(wc -l < proxies.txt)
            TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
            git commit -m "ğŸ”„ Update: ${PROXY_COUNT} proxies [${TIMESTAMP}]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°"
          fi
